// Generated by CoffeeScript 1.9.1
var FileInfo, path, sep, testObjectPathRegExp, testSpecPathRegExp;

path = require('path');

sep = path.sep === '\\' ? '\\\\' : path.sep;

testSpecPathRegExp = new RegExp('test' + sep + '.*' + sep + 'specs' + sep + '.*\\.coffee$');

testObjectPathRegExp = new RegExp('test' + sep + '.*' + sep + '(page-objects|helpers)' + sep + '.*\\.coffee$');

FileInfo = (function() {
  function FileInfo() {}


  /*
  @static
   */

  FileInfo.baseDir = null;

  FileInfo.targetDir = null;

  FileInfo.bundleTree = {};

  FileInfo.setDirs = function(base, target) {
    this.baseDir = base;
    return this.targetDir = target;
  };

  FileInfo.setBundles = function(bundles) {

    /*
    Registers bundle list from the application configuration to be able to detect bundle by the given file path
    @param Array[String] bundles
     */
    var bundle, curLevel, i, j, last, len, part, parts, results;
    results = [];
    for (j = 0, len = bundles.length; j < len; j++) {
      bundle = bundles[j];
      parts = bundle.split('/');
      last = parts.length - 1;
      curLevel = this.bundleTree;
      results.push((function() {
        var k, len1, results1;
        results1 = [];
        for (i = k = 0, len1 = parts.length; k < len1; i = ++k) {
          part = parts[i];
          if (curLevel[part] == null) {
            curLevel[part] = i === last ? true : {};
          }
          results1.push(curLevel = curLevel[part]);
        }
        return results1;
      })());
    }
    return results;
  };

  FileInfo.getTargetForSource = function(srcAbsPath) {

    /*
    Returns absolute target file path for the given absolute source file path.
    @param String srcAbsPath
    @return String
     */
    var info, relativePath;
    relativePath = srcAbsPath.substr(this.baseDir.length + 1);
    info = this.getFileInfo(relativePath, this.detectBundle(relativePath));
    return path.join(this.targetDir, this.getBuildDestinationFile(relativePath, info));
  };

  FileInfo.detectBundle = function(file) {

    /*
    Returns bundle name for the given relative file path.
    @param String file relative (to the base dir) file path
    @return String
     */
    var bundles, curLevel, j, len, ns, parts, result;
    parts = file.split('/');
    bundles = parts.shift();
    bundles = parts.shift();
    if (bundles === 'bundles') {
      curLevel = this.bundleTree;
      result = [];
      for (j = 0, len = parts.length; j < len; j++) {
        ns = parts[j];
        if (curLevel[ns] != null) {
          result.push(ns);
          if (curLevel[ns] === true) {
            break;
          } else {
            curLevel = curLevel[ns];
          }
        } else {
          result = [];
          break;
        }
      }
      return result.join('/');
    } else {
      return '';
    }
  };

  FileInfo.getFileInfo = function(file, bundle) {

    /*
    Returns a lot of file properties from the framework's point of view
    @param String file path to file
    @param (optional)String bundle bundle to which this file belongs
    @return Object key-value with file properties
     */
    var bundleOk, bundleParts, ext, fileName, fileWithoutExt, i, inApp, inBundleIndex, inBundles, inModels, inPublic, inTemplates, inWidgets, isBehaviour, isCollection, isModelRepo, isWidget, isWidgetTemplate, j, lastDirName, len, lowerName, p, parts;
    parts = file.split('/');
    inPublic = parts[0] === 'public';
    fileName = parts.pop();
    lastDirName = parts[parts.length - 1];
    ext = path.extname(fileName);
    fileWithoutExt = fileName.slice(0, -ext.length);
    if (inPublic) {
      inBundles = parts[1] === 'bundles';
      if (inBundles) {
        bundleParts = bundle.split('/');
        bundleOk = true;
        for (i = j = 0, len = bundleParts.length; j < len; i = ++j) {
          p = bundleParts[i];
          if (p !== parts[2 + i]) {
            bundleOk = false;
            break;
          }
        }
        if (bundleOk) {
          inBundleIndex = 2 + bundleParts.length;
          inWidgets = parts[inBundleIndex] === 'widgets';
          inTemplates = parts[inBundleIndex] === 'templates';
          inModels = parts[inBundleIndex] === 'models';
          if (inWidgets) {
            if (ext === '.coffee') {
              lowerName = fileWithoutExt.charAt(0).toLowerCase() + fileWithoutExt.slice(1);
              isWidget = lastDirName === lowerName;
              isBehaviour = (lastDirName + 'Behaviour') === lowerName;
            } else if (ext === '.html') {
              isWidgetTemplate = lastDirName === fileWithoutExt;
            }
          } else if (inModels) {
            isModelRepo = ext === '.coffee' && fileWithoutExt.substr(-4) === 'Repo';
            isCollection = ext === '.coffee' && fileWithoutExt.substr(-10) === 'Collection';
          }
        }
      } else {
        bundle = null;
        inApp = parts[1] === 'app';
      }
    }
    return {
      fileName: fileName,
      ext: ext,
      fileNameWithoutExt: fileWithoutExt,
      lastDirName: lastDirName,
      bundle: bundle,
      inPublic: inPublic,
      inBundles: inBundles != null ? inBundles : false,
      inWidgets: inWidgets != null ? inWidgets : false,
      inTemplates: inTemplates != null ? inTemplates : false,
      inModels: inModels != null ? inModels : false,
      isAppConfig: inApp && lastDirName === 'app' && ext === '.coffee',
      isWidget: isWidget != null ? isWidget : false,
      isBehaviour: isBehaviour != null ? isBehaviour : false,
      isWidgetTemplate: isWidgetTemplate != null ? isWidgetTemplate : false,
      isModelRepo: isModelRepo != null ? isModelRepo : false,
      isCollection: isCollection != null ? isCollection : false,
      isCoffee: ext === '.coffee',
      isHtml: ext === '.html',
      isStylus: ext === '.styl',
      isTestSpec: file.match(testSpecPathRegExp) != null,
      isTestObject: file.match(testObjectPathRegExp) != null
    };
  };

  FileInfo.getBuildDestinationFile = function(file, info) {

    /*
    Returns destination file relative name based on source file and framework-related information
    @param String file relative file name
    @param Object info framework-related information about the file
    @return String
     */
    if (info.isCoffee) {
      return path.dirname(file) + path.sep + info.fileNameWithoutExt + '.js';
    } else if (info.isStylus) {
      return path.dirname(file) + path.sep + info.fileNameWithoutExt + '.css';
    } else if (info.isWidgetTemplate) {
      return file + '.js';
    } else {
      return file;
    }
  };

  return FileInfo;

})();

module.exports = FileInfo;
