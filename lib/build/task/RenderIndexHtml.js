// Generated by CoffeeScript 1.9.1
var BuildTask, Future, RenderIndexHtml, fs, path, pathToCore, requirejs, requirejsConfig,
  extend = function(child, parent) { for (var key in parent) { if (hasProp.call(parent, key)) child[key] = parent[key]; } function ctor() { this.constructor = child; } ctor.prototype = parent.prototype; child.prototype = new ctor(); child.__super__ = parent.prototype; return child; },
  hasProp = {}.hasOwnProperty;

fs = require('fs');

path = require('path');

requirejs = require(process.cwd() + '/node_modules/requirejs');

Future = require('../../utils/Future');

BuildTask = require('./BuildTask');

requirejsConfig = require('./requirejs-config');

pathToCore = 'bundles/cord/core';

RenderIndexHtml = (function(superClass) {
  extend(RenderIndexHtml, superClass);

  function RenderIndexHtml() {
    return RenderIndexHtml.__super__.constructor.apply(this, arguments);
  }


  /*
  Renders and saves given widget (came from -I --index CLI option) as main index.html page.
  This is need mainly for mobile apps (phonegap) working in SPA mode.
   */

  RenderIndexHtml.prototype.run = function() {
    var browserInitPromise, config, dst, nodeInit;
    dst = this.params.targetDir + "/public/index.html";
    nodeInit = require(path.join(this.params.targetDir, 'public', pathToCore, 'init/nodeInit'));
    config = nodeInit.loadConfig(this.params.info.configName);
    global.appConfig = config;
    global.config = config.node;
    global.CORD_PROFILER_ENABLED = config.node.debug.profiler.enable;
    browserInitPromise = Future.call(fs.readFile, path.join(this.params.targetDir, 'public/assets/z/browser-init.id'), 'utf8').then(function(id) {
      global.config.browserInitScriptId = id;
    })["catch"](function() {});
    return Future.all([browserInitPromise, requirejsConfig(this.params.targetDir)]).then(function() {
      return Future.require('cord!AppConfigLoader', 'cord!utils/DomInfo', 'cord!ServiceContainer', 'cord!WidgetRepo', 'cord!router/serverSideRouter');
    }).spread((function(_this) {
      return function(AppConfigLoader, DomInfo, ServiceContainer, WidgetRepo, ServerSideRouter) {
        var container, widgetRepo;
        config = ServerSideRouter.constructor.replaceConfigVarsByHost(config, '127.0.0.1', 'http');
        global.appConfig = config;
        global.config = config.node;
        container = new ServiceContainer;
        container.set('container', container);
        container.set('config', global.config);
        container.set('appConfig', global.appConfig);
        widgetRepo = new WidgetRepo;
        widgetRepo.setServiceContainer(container);
        return AppConfigLoader.ready().then(function(appConfig) {
          var fn, info, ref, serviceName;
          appConfig.services.cookie = {
            deps: ['container'],
            factory: function(get, done) {
              return requirejs(['cord!/cord/core/cookie/LocalCookie'], (function(_this) {
                return function(Cookie) {
                  return done(null, new Cookie(get('container')));
                };
              })(this));
            }
          };
          ref = appConfig.services;
          fn = function(info) {
            return container.def(serviceName, info.deps, function(get, done) {
              return info.factory.call(container, get, done);
            });
          };
          for (serviceName in ref) {
            info = ref[serviceName];
            fn(info);
          }
          return widgetRepo.createWidget(_this.params.file).then(function(rootWidget) {
            rootWidget._isExtended = true;
            widgetRepo.setRootWidget(rootWidget);
            return rootWidget.show({}, DomInfo.fake());
          });
        });
      };
    })(this)).then(function(out) {
      return Future.call(fs.writeFile, dst, out);
    }).link(this.readyPromise);
  };

  return RenderIndexHtml;

})(BuildTask);

module.exports = RenderIndexHtml;
